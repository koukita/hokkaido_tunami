<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>秋田県津波浸水深マップ</title>
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />

  <link rel="stylesheet" href="https://koukita.github.io/opendata/hodmap/css/leaflet_v1.3.4.css" />
  <script src="https://koukita.github.io/opendata/hodmap/js/leaflet_v1.3.4.js"></script>
  <script src="https://koukita.github.io/opendata/hodmap/js/Leaflet.VectorGrid.bundled.min_v1.3.0.js"></script>

  <style>
    /* 浸水深などを表示するるテキストボックスのCSS */
    .infostyle {
      border: solid 1px;
      background-color: azure;
      border-radius: 10px;
      opacity: 0.8;
      padding: 5px;
      font-size: 15px;
      color: black;
    }
  </style>

</head>

<body>
  <div id="map" style="position:absolute;top:0;left:0;bottom:0;right:0;"></div>
  <script>
    //＝＝参考にしたWebサイト＝＝
    //【Leaflet.VectorGrid でバイナリベクトルタイルを表示する】https://qiita.com/frogcat/items/36e9e7525537c748f952
    //【Github：Leaflet.VectorGrid】https://github.com/Leaflet/Leaflet.VectorGrid
    //【VectorGridのページ】：https://leaflet.github.io/Leaflet.VectorGrid/vectorgrid-api-docs.html
    //【Leafletの地図上にテキストボックスを配置】https://ktgis.net/service/leafletlearn/advanced.html#step13
    //＝＝＝＝＝＝＝＝＝＝＝＝＝＝

    //＝＝＝URLに緯度経度、Zoomレベルを入力する＝＝＝＝
    //初期値
    var center_lat=39.724089;
    var center_lng=139.949341;
    var zoom_level=10; 

    //URLパラメータの緯度経度、ズームレベルを取得する
    //参考：http://qiita.com/tonkatu_tanaka/items/99d167ded9330dbc4019
    var arg = new Object; //変数をオブジェクトで作成
    var pair = location.search.substring(1).split('&');    //URLの後ろの「？」からで「＆」で区切ったものを配列で代入
    //パラメータの数だけループ
    for(var i=0;pair[i];i++) {
        //「=」で区切って、キーと値に分ける
        var kv = pair[i].split('=');
        //変数argに配列を代入
        arg[kv[0]]=kv[1];
    };

    //URLにパラメータがある場合に、緯度経度とズームレベルを更新する
    if(i>0){
        //配列から緯度経度とズームレベルを表示する
        center_lat = arg.lat;
        center_lng = arg.lng;
        zoom_level = arg.zoom;
    }; 

    //＝＝＝＝＝＝＝Leaflet地図の設定＝＝＝＝＝＝＝
    var map = L.map("map", {
      minZoom: 10,
      maxZoom: 14,
      zoom: zoom_level,
	  center: [center_lat, center_lng]
    });
    //地図を移動し終わったときに、センターの座標を取得
    map.on('moveend',function(){
        //URLに地図の中心座標を入力
        history.replaceState('','','hokkaido_tunami.html?lat=' + map.getCenter().lat + '&lng=' + map.getCenter().lng + '&zoom=' + map.getZoom());
    });

    //＝＝＝＝＝＝＝背景地図の設定＝＝＝＝＝＝＝＝
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>",
      minZoom: 10,
      maxNativeZoom: 16
    }).addTo(map);

    //＝＝＝＝＝＝テキストボックスの設定＝＝＝＝＝＝＝＝
    //浸水深を表示するためのテキストボックスを左上にdivコントロールで表示
    var maxsin_box = L.control({ position: "topleft" });
    maxsin_box.onAdd = function (map) {
        //divを作成
        this.ele = L.DomUtil.create('div', "infostyle");
        //後で使うためにidを設定
        this.ele.id = "maxsin_div";
        //最初は非表示
        this.ele.style.visibility = "hidden";
        //div上のとmousemoveイベントがmapに連鎖しないように設定
        this.ele.onmousemove = function (e) { e.stopPropagation() };
        return this.ele;
    };
    maxsin_box.addTo(map);
    //はじめのテキストボックスを表示する     
    var box_1 = document.getElementById("maxsin_div");
    var html_1 = "浸水深（MAX_SIN）:    m<br>" +
        "市町村:         m";
      box_1.innerHTML = html_1;
      box_1.style.visibility = "visible";


    //＝＝＝＝スタイルをクリアするための関数＝＝＝＝
    //マウスが地物から移動した場合に、スタイルをもとに戻す
    var highlight;
		var clearHighlight = function() {
			if (highlight) {
        vectorGrid_1.resetFeatureStyle(highlight);
			}
			highlight = null;
		};

    //＝＝＝＝＝＝＝ベクタタイルを地図に表示する＝＝＝＝＝＝＝＝
    //秋田県津波浸水深　2023年2月ダウンロード
    var vectorGrid_1 = L.vectorGrid.protobuf("https://koukita.github.io/hokkaido_tunami/akitaken_vectortile/{z}/{x}/{y}.pbf", {
      attribution: "<a href='https://www.pref.akita.lg.jp/pages/archive/53932' target='_blank'>津波浸水想定データ</a>",
      maxNativeZoom: 16,
      minNativeZoom: 10,
      //minZoom: 12,
      rendererFactory: L.canvas.tile,
      vectorTileLayerStyles: {
        "最大浸水深": function(properties, zoom) { //レイヤを指定し、浸水深で色分類
					var p = properties.GRIDCODE;
					return {
						fillColor:
                p <= 500 ? '#ffff00' :
								p <= 1000 ? '#ff8000' :
								p <= 1500 ? '#ff5b5b' :
								p <= 2000 ? '#dd000b' : '#800080',
						fillOpacity: 0.7, //透過率
						stroke: true,
						fill: true,
						color: 'red',
						weight: 0.1,
					}
        }
      },
      //スタイルを更新するためのオプション
      //これを設定しないと、mouseoverイベントでスタイルを設定できない
      interactive: true,
			getFeatureId: function(f) {
				return f.properties.ID; //一意のIDを指定
			}
    })
    .on('mouseover', function(e) {  //マウスムーブイベント
      var properties = e.layer.properties;
      //テキストボックスに値を表示する     
      var box = document.getElementById("maxsin_div");
      var html = "GRIDCODE:" + properties.GRIDCODE + "m<br>" 
      box.innerHTML = html;
      box.style.visibility = "visible";

      //カーソルが外れた場合にスタイルをもとに戻す
      clearHighlight();
			highlight = properties.ID;
      
      //マウスのあるところのスタイルを設定
      var style = {
				fillColor: 'red',
				fillOpacity: 1.0,
				stroke: true,
				fill: true,
				color: 'red',
				opacity: 1,
				weight: 2,
			};
      //スタイルを適用
		  vectorGrid_1.setFeatureStyle(properties.ID, style);

    }).addTo(map);

  </script>
</body>

</html>